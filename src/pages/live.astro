---
import Layout from '../layouts/Layout.astro';
import { links, site, visuals } from '../config/site';

const channelId = import.meta.env.PUBLIC_YOUTUBE_CHANNEL_ID?.trim() ?? '';
const channelUrl = import.meta.env.PUBLIC_YOUTUBE_CHANNEL_URL?.trim() ?? import.meta.env.PUBLIC_YOUTUBE_URL?.trim() ?? '';
const siteOrigin = import.meta.env.PUBLIC_SITE_ORIGIN?.trim() ?? '';
const fallbackVideoId =
  import.meta.env.PUBLIC_LIVE_FALLBACK_YT_VIDEO_ID?.trim() ??
  import.meta.env.PUBLIC_HOME_FEATURED_YT_VIDEO_ID?.trim() ??
  '';
const youtubeApiKey = import.meta.env.YOUTUBE_API_KEY?.trim() ?? '';

let liveVideoId: string | null = null;

if (channelId && youtubeApiKey) {
  const endpoint = new URL('https://www.googleapis.com/youtube/v3/search');
  endpoint.searchParams.set('part', 'id');
  endpoint.searchParams.set('channelId', channelId);
  endpoint.searchParams.set('eventType', 'live');
  endpoint.searchParams.set('type', 'video');
  endpoint.searchParams.set('order', 'date');
  endpoint.searchParams.set('maxResults', '1');
  endpoint.searchParams.set('fields', 'items(id/videoId)');
  endpoint.searchParams.set('key', youtubeApiKey);

  try {
    const response = await fetch(endpoint, {
      headers: { Accept: 'application/json' },
      cache: 'no-store',
    });
    if (response.ok) {
      const json = (await response.json()) as {
        items?: Array<{ id?: { videoId?: string } }>;
      };
      liveVideoId = json.items?.[0]?.id?.videoId?.trim() ?? null;
    } else {
      console.warn(`[/live] Failed to fetch live video id: ${response.status}`);
    }
  } catch (error) {
    console.warn('[/live] Live detection failed:', error);
  }
} else if (channelId && !youtubeApiKey) {
  console.warn('[/live] YOUTUBE_API_KEY is not configured. Live detection is disabled.');
}

const isLive = Boolean(liveVideoId);

const liveEmbedUrl = liveVideoId
  ? `https://www.youtube-nocookie.com/embed/${encodeURIComponent(liveVideoId)}`
  : channelId
    ? `https://www.youtube.com/embed/live_stream?channel=${encodeURIComponent(channelId)}${siteOrigin ? `&origin=${encodeURIComponent(siteOrigin)}` : ''}`
    : '';

const recommendedEmbedUrl = fallbackVideoId
  ? `https://www.youtube-nocookie.com/embed/${encodeURIComponent(fallbackVideoId)}`
  : '';

const initialMode: 'live' | 'recommended' = isLive ? 'live' : 'recommended';
const initialEmbedUrl = initialMode === 'live' ? liveEmbedUrl || recommendedEmbedUrl : recommendedEmbedUrl || liveEmbedUrl;
---

<Layout title={`${site.title} | Live`} description="配信ページ">
  <section class="section-block" style={`background-image: url('${visuals.live}')`}>
    <div class="section-content">
      <p class="eyebrow">Live</p>
      <h1 class="hero-title">配信ページ</h1>
      <p class="hero-sub">{isLive ? '現在ライブ配信中の映像を表示しています。' : '現在ライブ配信がないため、おすすめ動画を表示しています。'}</p>

      {
        initialEmbedUrl ? (
          <div class="live-player-wrap content-card" data-live-panel>
            <div class="switch-row" role="tablist" aria-label="Live表示切り替え">
              <button
                class={`switch-button${initialMode === 'live' ? ' is-active' : ''}`}
                type="button"
                data-mode="live"
                role="tab"
                aria-selected={initialMode === 'live' ? 'true' : 'false'}
                disabled={!isLive}
                aria-disabled={!isLive ? 'true' : 'false'}
              >
                ライブを見る
              </button>
              <button
                class={`switch-button${initialMode === 'recommended' ? ' is-active' : ''}`}
                type="button"
                data-mode="recommended"
                role="tab"
                aria-selected={initialMode === 'recommended' ? 'true' : 'false'}
              >
                おすすめ動画を見る
              </button>
            </div>
            <div class="player-shell" data-player-wrap>
              <iframe
                title="Live Stream"
                src={initialEmbedUrl}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
              ></iframe>
            </div>
          </div>
        ) : (
          <div class="embed-fallback content-card">動画IDが未設定のため埋め込みを表示できません。</div>
        )
      }

      <div class="content-card links-card">
        <a class="platform-link" href={channelUrl || links.youtube} target="_blank" rel="noreferrer">YouTube</a>
        <a class="platform-link" href={links.twitch} target="_blank" rel="noreferrer">Twitch</a>
        <a class="platform-link" href={links.kick} target="_blank" rel="noreferrer">Kick</a>
      </div>
    </div>
  </section>
</Layout>

<script type="module" define:vars={{ liveEmbedUrl, recommendedEmbedUrl, initialMode }}>
  const panels = document.querySelectorAll('[data-live-panel]');

  panels.forEach((panel) => {
    const iframe = panel.querySelector('iframe');
    const buttons = panel.querySelectorAll('[data-mode]');
    if (!iframe || buttons.length === 0) return;

    const setMode = (mode) => {
      const nextSrc = mode === 'recommended' ? recommendedEmbedUrl || liveEmbedUrl : liveEmbedUrl || recommendedEmbedUrl;
      if (nextSrc && iframe.getAttribute('src') !== nextSrc) {
        iframe.setAttribute('src', nextSrc);
      }

      buttons.forEach((button) => {
        const buttonMode = button.getAttribute('data-mode') || '';
        const isActive = buttonMode === mode;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
    };

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.hasAttribute('disabled')) return;
        const mode = button.getAttribute('data-mode') === 'recommended' ? 'recommended' : 'live';
        setMode(mode);
      });
    });

    setMode(initialMode);
  });
</script>

<style>
  .live-player-wrap {
    display: grid;
    gap: 0.8rem;
    padding: 0.7rem;
  }

  .switch-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .switch-button {
    border: 1px solid rgba(190, 220, 247, 0.35);
    background: rgba(10, 15, 24, 0.55);
    color: #dbeeff;
    border-radius: 999px;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
  }

  .switch-button.is-active {
    background: rgba(132, 233, 255, 0.2);
    border-color: rgba(132, 233, 255, 0.58);
  }

  .switch-button:disabled {
    cursor: not-allowed;
    opacity: 0.45;
  }

  .player-shell {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(191, 220, 247, 0.34);
    background: rgba(4, 8, 14, 0.76);
  }

  .player-shell iframe {
    width: 100%;
    height: 100%;
    border: 0;
  }

  .embed-fallback {
    min-height: 150px;
    display: grid;
    place-items: center;
    text-align: center;
  }

  .links-card {
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
  }

  .platform-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.42rem 0.72rem;
    border-radius: 999px;
    border: 1px solid rgba(190, 220, 247, 0.35);
    background: rgba(10, 15, 24, 0.52);
    color: #d5e9fc;
    text-decoration: none;
    font-size: 0.85rem;
    min-width: 7.5rem;
  }

  .platform-link:hover {
    border-color: rgba(132, 233, 255, 0.52);
    background: rgba(18, 29, 42, 0.6);
  }
</style>
