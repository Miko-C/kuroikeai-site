---
import Layout from '../layouts/Layout.astro';
import { links, site, visuals } from '../config/site';

const channelId = import.meta.env.PUBLIC_YOUTUBE_CHANNEL_ID?.trim() ?? '';
const channelUrl = import.meta.env.PUBLIC_YOUTUBE_CHANNEL_URL?.trim() ?? import.meta.env.PUBLIC_YOUTUBE_URL?.trim() ?? '';
const recommendedVideoId =
  import.meta.env.PUBLIC_LIVE_FALLBACK_YT_VIDEO_ID?.trim() ??
  import.meta.env.PUBLIC_HOME_FEATURED_YT_VIDEO_ID?.trim() ??
  '';
const liveEmbedUrl = channelId
  ? `https://www.youtube-nocookie.com/embed/live_stream?channel=${encodeURIComponent(channelId)}`
  : '';
const recommendedEmbedUrl = recommendedVideoId
  ? `https://www.youtube-nocookie.com/embed/${encodeURIComponent(recommendedVideoId)}`
  : '';
const initialTab: 'live' | 'recommended' = 'live';
---

<Layout title={`${site.title} | Live`} description="配信ページ">
  <section class="section-block" style={`background-image: url('${visuals.live}')`}>
    <div class="section-content">
      <p class="eyebrow">Live</p>
      <h1 class="hero-title">配信ページ</h1>
      <p class="hero-sub">初期表示はライブです。「ライブを見る」と「おすすめ動画を見る」を切り替えて視聴できます。</p>

      {
        liveEmbedUrl || recommendedEmbedUrl ? (
          <div class="live-player-wrap content-card" data-live-panel>
            <div class="switch-row" role="tablist" aria-label="Live表示切り替え">
              <button
                class={`switch-button${initialTab === 'live' ? ' is-active' : ''}`}
                type="button"
                data-tab="live"
                role="tab"
                aria-selected={initialTab === 'live' ? 'true' : 'false'}
              >
                ライブを見る
              </button>
              <button
                class={`switch-button${initialTab === 'recommended' ? ' is-active' : ''}`}
                type="button"
                data-tab="recommended"
                role="tab"
                aria-selected={initialTab === 'recommended' ? 'true' : 'false'}
              >
                おすすめ動画を見る
              </button>
            </div>
            <div class="player-shell" data-player-wrap>
              <iframe
                id="live-player"
                class="player-frame"
                title="Live Stream"
                src={initialTab === 'live' ? liveEmbedUrl : ''}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
              ></iframe>
              <iframe
                id="recommended-player"
                class="player-frame is-hidden"
                title="Recommended Video"
                src=""
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                referrerpolicy="strict-origin-when-cross-origin"
              ></iframe>
            </div>
          </div>
        ) : (
          <div class="embed-fallback content-card">動画IDが未設定のため埋め込みを表示できません。</div>
        )
      }

      <div class="content-card links-card">
        <a class="platform-link" href={channelUrl || links.youtube} target="_blank" rel="noreferrer">YouTube</a>
        <a class="platform-link" href={links.twitch} target="_blank" rel="noreferrer">Twitch</a>
        <a class="platform-link" href={links.kick} target="_blank" rel="noreferrer">Kick</a>
      </div>
    </div>
  </section>
</Layout>

<script type="module" define:vars={{ liveEmbedUrl, recommendedEmbedUrl, initialTab }}>
  const panels = document.querySelectorAll('[data-live-panel]');

  panels.forEach((panel) => {
    const liveFrame = panel.querySelector('#live-player');
    const recommendedFrame = panel.querySelector('#recommended-player');
    const buttons = panel.querySelectorAll('[data-tab]');
    if (!liveFrame || !recommendedFrame || buttons.length === 0) return;

    const frameByTab = {
      live: liveFrame,
      recommended: recommendedFrame,
    };

    const srcByTab = {
      live: liveEmbedUrl,
      recommended: recommendedEmbedUrl,
    };

    const setTab = (tab) => {
      const requestedTab = tab === 'recommended' ? 'recommended' : 'live';
      const nextTab = srcByTab[requestedTab] ? requestedTab : requestedTab === 'live' ? 'recommended' : 'live';
      const otherTab = nextTab === 'live' ? 'recommended' : 'live';
      const activeFrame = frameByTab[nextTab];
      const hiddenFrame = frameByTab[otherTab];
      const activeSrc = srcByTab[nextTab];

      hiddenFrame.setAttribute('src', '');
      hiddenFrame.classList.add('is-hidden');

      if (activeSrc) {
        activeFrame.setAttribute('src', activeSrc);
      } else {
        activeFrame.setAttribute('src', '');
      }
      activeFrame.classList.remove('is-hidden');

      buttons.forEach((button) => {
        const buttonTab = button.getAttribute('data-tab') === 'live' ? 'live' : 'recommended';
        const isActive = buttonTab === nextTab;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
    };

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab') === 'live' ? 'live' : 'recommended';
        setTab(tab);
      });
    });

    setTab(initialTab);
  });
</script>

<style>
  .live-player-wrap {
    display: grid;
    gap: 0.8rem;
    padding: 0.7rem;
  }

  .switch-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .switch-button {
    border: 1px solid rgba(190, 220, 247, 0.35);
    background: rgba(10, 15, 24, 0.55);
    color: #dbeeff;
    border-radius: 999px;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
  }

  .switch-button.is-active {
    background: rgba(132, 233, 255, 0.2);
    border-color: rgba(132, 233, 255, 0.58);
  }

  .player-shell {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(191, 220, 247, 0.34);
    background: rgba(4, 8, 14, 0.76);
  }

  .player-frame {
    width: 100%;
    height: 100%;
    border: 0;
  }

  .player-frame.is-hidden {
    display: none;
  }

  .player-shell {
    position: relative;
  }

  .player-shell iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  .embed-fallback {
    min-height: 150px;
    display: grid;
    place-items: center;
    text-align: center;
  }

  .links-card {
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
  }

  .platform-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.42rem 0.72rem;
    border-radius: 999px;
    border: 1px solid rgba(190, 220, 247, 0.35);
    background: rgba(10, 15, 24, 0.52);
    color: #d5e9fc;
    text-decoration: none;
    font-size: 0.85rem;
    min-width: 7.5rem;
  }

  .platform-link:hover {
    border-color: rgba(132, 233, 255, 0.52);
    background: rgba(18, 29, 42, 0.6);
  }
</style>
